<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register | AgroFarm</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* ðŸ”¹ Flash popup */
    #flashMessage {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 28px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      z-index: 9999;
      display: none;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* ðŸ”¹ Password toggle icon */
    .password-wrapper {
      position: relative;
    }
    .password-wrapper i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #555;
    }
    .password-wrapper input {
      width: 100%;
      padding-right: 30px;
    }

    /* ðŸ”¹ Strength bar */
    #passwordStrengthBar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 6px;
      margin-top: 5px;
      overflow: hidden;
    }
    #passwordStrengthBar div {
      height: 100%;
      width: 0%;
      border-radius: 6px;
      background: red;
      transition: width 0.4s ease, background 0.4s ease;
    }
  </style>
</head>
<body>

  <!-- Flash message -->
  <div id="flashMessage"></div>

  <section class="auth-section">
    <div class="auth-container">
      <button type="button" class="close-btn" id="closeForm" aria-label="Close">Ã—</button>

      <div class="auth-header">
        <h2>Create Your Profile</h2>
      </div>

      <form id="registerForm" class="auth-body" method="POST" action="{{ url_for('register') }}">
        <div class="form-row">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" name="full_name" required placeholder="Enter your name">
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required placeholder="example@gmail.com">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="mobile">Mobile Number</label>
            <input type="tel" id="mobile" name="mobile" required placeholder="e.g. +92 300 1234567">
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" name="location" required placeholder="City, State, Country">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="profession">Profession</label>
            <select id="profession" name="profession" required>
              <option value="">Select Profession</option>
              <option value="Farmer">Farmer</option>
              <option value="Academics">Academics</option>
              <option value="Consultant">Consultant</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="expertise">Level of Expertise</label>
            <select id="expertise" name="expertise" required>
              <option value="">Select Level</option>
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Expert">Expert</option>
            </select>
          </div>
        </div>

        <div class="form-group full">
          <label for="profilePic">Profile Picture</label>
          <input type="file" id="profilePic" name="profilePic" accept="image/*">
        </div>

        <!-- Password with show/hide -->
        <div class="form-group full password-wrapper">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required placeholder="Enter password">
          <i id="togglePassword" class="bi bi-eye"></i>
        </div>

        <div class="form-group full password-wrapper">
          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" name="confirm_password" required placeholder="Re-enter password">
          <i id="toggleConfirmPassword" class="bi bi-eye"></i>
          <div id="passwordMatch" style="font-size:0.9em; margin-top:5px;"></div>
        </div>

        <div class="form-group full">
          <div id="passwordStrength">
            Strength: <span>Weak</span>
          </div>
          <div id="passwordStrengthBar">
            <div></div>
          </div>
        </div>

        <div class="form-group full">
          <button type="submit" class="auth-btn">Register</button>
        </div>

        <div class="form-group full auth-switch">
          <p>Already have an account? <a href="{{ url_for('login') }}">Login here</a></p>
        </div>
      </form>
    </div>
  </section>

  <!-- JS -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const flashMessage = document.getElementById("flashMessage");

      function showFlash(msg, type="info") {
        flashMessage.textContent = msg;
        flashMessage.style.display = "block";
        flashMessage.style.opacity = "1";

        switch(type){
          case "success": flashMessage.style.backgroundColor = "#28a745"; break;
          case "danger": flashMessage.style.backgroundColor = "#dc3545"; break;
          case "warning": flashMessage.style.backgroundColor = "#ffc107"; flashMessage.style.color="#000"; break;
          default: flashMessage.style.backgroundColor="#17a2b8";
        }

        setTimeout(()=>{
          flashMessage.style.transition="opacity 0.5s";
          flashMessage.style.opacity="0";
          setTimeout(()=>flashMessage.style.display="none", 500);
        }, 2500);
      }

      // -------------------
      // Password toggle
      // -------------------
      const passwordInput = document.getElementById("password");
      const confirmInput = document.getElementById("confirmPassword");
      const togglePass = document.getElementById("togglePassword");
      const toggleConfirm = document.getElementById("toggleConfirmPassword");

      togglePass.addEventListener("click", ()=>{
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;
        togglePass.className = type==="password"?"bi bi-eye":"bi bi-eye-slash";
      });

      toggleConfirm.addEventListener("click", ()=>{
        const type = confirmInput.type === "password" ? "text" : "password";
        confirmInput.type = type;
        toggleConfirm.className = type==="password"?"bi bi-eye":"bi bi-eye-slash";
      });

      // -------------------
      // Password strength
      // -------------------
      const strengthText = document.querySelector("#passwordStrength span");
      const strengthBar = document.querySelector("#passwordStrengthBar div");
      const passwordMatch = document.getElementById("passwordMatch");

      function updateStrength() {
        const val = passwordInput.value;
        let strength="Weak", width="33%", color="red";

        if(val.length>=8 && /[A-Z]/.test(val) && /[0-9]/.test(val) && /[\W]/.test(val)){
          strength="Strong"; width="100%"; color="green";
        } else if(val.length>=6){
          strength="Medium"; width="66%"; color="orange";
        }

        strengthText.textContent = strength;
        strengthBar.style.width = width;
        strengthBar.style.background = color;

        checkMatch();
      }

      function checkMatch(){
        if(confirmInput.value.length===0){ passwordMatch.textContent=""; return; }
        if(confirmInput.value !== passwordInput.value){
          passwordMatch.textContent="Passwords do not match!";
          passwordMatch.style.color="red";
        } else {
          passwordMatch.textContent="Passwords match âœ…";
          passwordMatch.style.color="green";
        }
      }

      passwordInput.addEventListener("input", updateStrength);
      confirmInput.addEventListener("input", checkMatch);

      // -------------------
      // Form submit
      // -------------------
      const registerForm = document.getElementById("registerForm");
      registerForm.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const email = document.getElementById("email").value.trim();

        // 1ï¸âƒ£ Check email via AJAX
        try{
          const res = await fetch(`/check-email?email=${encodeURIComponent(email)}`);
          const data = await res.json();
          if(data.exists){
            showFlash("This email is already registered!", "danger");
            return;
          }
        } catch(err){ console.error(err); }

        // 2ï¸âƒ£ Check passwords
        if(passwordInput.value !== confirmInput.value){
          showFlash("Passwords do not match!", "danger");
          return;
        }

        // âœ… Submit form
        registerForm.submit();
      });

      // -------------------
      // Close button
      // -------------------
      document.getElementById("closeForm").addEventListener("click", ()=>{
        window.location.href="/";
      });

      // -------------------
      // Show server flash
      // -------------------
      const flaskFlash = document.getElementById("flashMessage");
      if(flaskFlash && flaskFlash.textContent.trim()!==""){
        showFlash(flaskFlash.textContent, flaskFlash.className || "info");
      }

    });
  </script>

  <!-- Bootstrap icons for eye/eye-slash -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

</body>
</html>
